/**
* Copyright 2025 RetoraDev
*
*   Licensed under the Apache License, Version 2.0 (the "License");
*   you may not use this file except in compliance with the License.
*   You may obtain a copy of the License at
*
*       http://www.apache.org/licenses/LICENSE-2.0
*
*   Unless required by applicable law or agreed to in writing, software
*   distributed under the License is distributed on an "AS IS" BASIS,
*   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
*   See the License for the specific language governing permissions and
*   limitations under the License.
*/

!function(t,s){"object"==typeof module&&"object"==typeof module.exports?module.exports=s():t.t=s()}("undefined"!=typeof window?window:this,function(){"use strict";const t={i:"[30m",red:"[31m",green:"[32m",o:"[33m",blue:"[34m",h:"[35m",l:"[36m",u:"[37m",reset:"[0m"},s={reset:"[0m",bold:"[1m",m:"[1m",p:"[1m",b:"[1m",v:"[3m",$:"[3m",k:"[3m",S:"[4m",_:"[4m",blink:"[5m",inverse:"[7m",hidden:"[8m"},i="lore_save_data",e={N:"#000000",I:"#ffffff",Y:"#00ff00",T:"#ffffff",A:"monospace",O:"16px",M:"#333333"},n={prompt:"> ",j:!1,P:30,debug:!1,L:!0,F:!1},o={G:"undefined"!=typeof window&&"undefined"!=typeof document,R:"undefined"!=typeof process&&process.versions&&process.versions.node,C:t=>({...t}),uuid:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){const s=16*Math.random()|0;return("x"===t?s:3&s|8).toString(16)}),J(t,s){let i;return function(...e){clearTimeout(i),i=setTimeout(()=>{clearTimeout(i),t(...e)},s)}},U:t=>({i:"#000000",red:"#ff0000",green:"#00ff00",o:"#ffff00",blue:"#0000ff",h:"#ff00ff",l:"#00ffff",u:"#ffffff"}[t.toLowerCase()]||t),D(t){if(!t)return!1;return!!["black","red","green","yellow","blue","magenta","cyan","white"].includes(t.toLowerCase())||/^#?([0-9A-F]{3}){1,2}$/i.test(t)},q:t=>t.startsWith("file://")||t.startsWith("./")||t.startsWith("../")||t.startsWith("http://")||t.startsWith("https://"),B:t=>"string"==typeof t?new Function(`const state = arguments[0]; const engine = arguments[1]; ${t}`):t,async K(t){try{const s=await fetch(t),i=await s.text();if(!s.ok)return console.error("File at",t,"not found!"),{};return new Function(`\n          const module = {\n              exports: {}\n            };\n            try {\n              ${i}\n            } catch(error) {\n              return module;\n              throw error;\n            }\n            return module;\n          `)().exports}catch(s){return console.error("Error loading module from ",t,s),{}}}};return{H:t,V:s,VERSION:"1.0.0",W:i,X:"> ",Z:e,tt:n,st:class{constructor(t={}){this.state={it:null,et:[],flags:{},nt:{},history:[],ot:0},this.config={...n,...t},this.rt={ht:new Map,items:new Map,lt:new Map,events:new Map,commands:new Map,ct:new Map},this.plugins=new Map,this.theme={...e},this.ft=-1,this.ut=!1,this.dt=!1,this.wt=[],this.outputBuffer=[],this.gt=new Map,this.bt=new Map,this.vt={color:null,bold:!1,v:!1,S:!1},this.yt={$t:!1,xt:null},o.G?this.kt():o.R&&this.St(),this._t()}kt(){this.Nt="browser",this.It=document.createElement("div"),this.It.className="lore-terminal",this.It.style.cssText=`\n          position: fixed;\n          top: 0;\n          left: 0;\n          width: 100%;\n          height: 100%;\n          background-color: ${this.theme["N"]};\n          color: ${this.theme["I"]};\n          font-family: ${this.theme["A"]};\n          font-size: ${this.theme["O"]};\n          overflow: auto;\n          padding: 20px;\n          box-sizing: border-box;\n        `,this.Yt=document.createElement("div"),this.Yt.className="lore-output",this.Yt.style.cssText="\n          height: calc(100% - 60px);\n          overflow-y: auto;\n          margin-bottom: 20px;\n          white-space: pre-wrap;\n        ",this.Tt=document.createElement("div"),this.Tt.className="lore-input-container",this.Tt.style.cssText="\n          display: flex;\n          align-items: center;\n          background: transparent;\n        ",this.At=document.createElement("span"),this.At.className="lore-prompt",this.At.textContent=this.Ot(this.config.prompt),this.Et=document.createElement("input"),this.Et.className="lore-input",this.Et.type="text",this.Et.style.cssText=`\n          flex: 1;\n          background: transparent;\n          border: none;\n          outline: none;\n          color: ${this.theme["T"]};\n          font-family: ${this.theme["A"]};\n          font-size: ${this.theme["O"]};\n          margin-left: 5px;\n        `,this.Tt.appendChild(this.At),this.Tt.appendChild(this.Et),this.It.appendChild(this.Yt),this.It.appendChild(this.Tt),document.querySelector(".lore-terminal")||(document.body.appendChild(this.It),document.body.style.margin="0",document.body.style.padding="0"),this.Mt()}St(){this.Nt="node",this.jt=require("readline"),this.Pt=require("fs"),this.path=require("path"),this.Lt=this.jt.Ft({input:process.stdin,Gt:process.stdout,prompt:this.Ot(this.config.prompt)}),this.Rt()}Mt(){this.Et.addEventListener("keydown",t=>{"Enter"===t.key?this.yt.$t?(this.Ct(),t.preventDefault()):(this.Jt(this.Et.value),this.Et.value="",t.preventDefault()):"ArrowUp"===t.key?(this.Ut(-1),t.preventDefault()):"ArrowDown"===t.key?(this.Ut(1),t.preventDefault()):"Tab"===t.key?(this.Dt(),t.preventDefault()):"Escape"===t.key&&this.yt.$t&&(this.Ct(),t.preventDefault())}),window.addEventListener("resize",o.J(()=>{this.Yt.scrollTop=this.Yt.scrollHeight},250)),this.It.addEventListener("click",()=>{this.Et.focus()})}Rt(){this.Lt.on("line",t=>{this.yt.$t?(this.Ct(),this.Lt.prompt()):(this.Jt(t),this.Lt.prompt())}).on("close",()=>{process.exit(0)}),this.Lt.on("SIGINT",()=>{this.yt.$t?(this.Ct(),this.Lt.prompt()):this.Lt.zt("Are you sure you want to exit? (y/n) ",t=>{t.match(/^y(es)?$/i)?this.Lt.close():this.Lt.prompt()})})}Ot(t){return"browser"===this.Nt?this.qt(t):this.Bt(t)}qt(t){const s=/\{\{([^}]+)\}\}/g;let i,e=0,n="";for(this.vt={color:null,bold:!1,v:!1,S:!1};null!==(i=s.exec(t));){n+=t.substring(e,i.index),e=i.index+i[0].length;const s=i[1].trim().toLowerCase();if("font_reset"===s||"fr"===s)n+="</span>",this.vt={color:null,bold:!1,v:!1,S:!1};else if("color_reset"===s)this.vt.color&&(n+="</span>",this.vt.color=null);else if(o.D(s)){this.vt.color&&(n+="</span>");const t=o.U(s.replace("#",""));n+=`<span style="color: ${t}">`,this.vt.color=t}else"bold"===s||"thick"===s||"strong"===s||"b"===s?this.vt.bold||(n+="<strong>",this.vt.bold=!0):"italic"===s||"cursive"===s||"i"===s?this.vt.v||(n+="<em>",this.vt.v=!0):"underline"===s||"u"===s?this.vt.S||(n+='<span style="text-decoration: underline">',this.vt.S=!0):"newline"===s||"n"===s?n+="<br>":"tabulator"===s||"tab"===s||"t"===s?n+="&nbsp;&nbsp;&nbsp;&nbsp;":"instant"===s&&(n+="")}return n+=t.substring(e),this.vt.S&&(n+="</span>"),this.vt.v&&(n+="</em>"),this.vt.bold&&(n+="</strong>"),this.vt.color&&(n+="</span>"),n}Bt(i){const e=/\{\{([^}]+)\}\}/g;let n,r=0,h="";for(this.vt={color:null,bold:!1,v:!1,S:!1};null!==(n=e.exec(i));){h+=i.substring(r,n.index),r=n.index+n[0].length;const e=n[1].trim().toLowerCase();if("font_reset"===e||"fr"===e)h+=s.reset,this.vt={color:null,bold:!1,v:!1,S:!1};else if("color_reset"===e)(this.vt.color||this.vt.bold||this.vt.v||this.vt.S)&&(h+=s.reset,this.vt={color:null,bold:!1,v:!1,S:!1});else if(o.D(e)){const s=e.replace("#","");t[s]&&(h+=t[s],this.vt.color=s)}else"bold"===e||"thick"===e||"strong"===e||"b"===e?this.vt.bold||(h+=s.bold,this.vt.bold=!0):"italic"===e||"cursive"===e||"i"===e?this.vt.v||(h+=s.v,this.vt.v=!0):"underline"===e||"u"===e?this.vt.S||(h+=s.S,this.vt.S=!0):"newline"===e||"n"===e?h+="\n":"tabulator"===e||"tab"===e||"t"===e?h+="\t":"instant"===e&&(h+="")}return h+=i.substring(r),(this.vt.color||this.vt.bold||this.vt.v||this.vt.S)&&(h+=s.reset),h}Jt(t){if(!t.trim())return;if(this.yt.xt||this.ut)return void this.Ct();this.state.history.push(t),this.ft=this.state.history.length,"browser"===this.Nt&&this.Kt(`${this.config.prompt}${t}`,!0);const[s,...i]=t.trim().split(/\s+/),e=s.toLowerCase();if(this.rt.commands.has(e))try{const t=this.rt.commands.get(e);t?.Ht?.call(this,i,this)}catch(t){this.Kt(`Error executing command: ${t.message}`),this.config.debug&&console.error(t)}else this.Kt(`Unknown command: ${s}. Type 'help' for available commands.`);this.config.j&&this.Qt("autosave",!0)}Ut(t){if(0!==this.state.history.length){if(this.ft+=t,this.ft<0)this.ft=0;else if(this.ft>=this.state.history.length)return this.ft=this.state.history.length,void(this.Et.value="");this.Et.value=this.state.history[this.ft]}}Dt(){const t=this.Et.value.trim();if(!t)return;const s=t.split(" "),i=s[s.length-1].toLowerCase(),e=[];for(const[t]of this.rt.commands)t.startsWith(i)&&e.push(t);for(const t of this.state.et){const s=this.rt.items.get(t);s&&s.name.toLowerCase().startsWith(i)&&e.push(s.name.toLowerCase())}const n=this.rt.ht.get(this.state.it);if(n){for(const t of n.items||[]){const s=this.rt.items.get(t);s&&s.name.toLowerCase().startsWith(i)&&e.push(s.name.toLowerCase())}for(const t of Object.keys(n.Vt||{}))t.toLowerCase().startsWith(i)&&e.push(t.toLowerCase())}if(1===e.length)s[s.length-1]=e[0],this.Et.value=s.join(" ");else if(e.length>1){const t=this.Wt(e);t.length>i.length&&(s[s.length-1]=t,this.Et.value=s.join(" ")),this.Kt("Suggestions: "+e.join(", "))}}Wt(t){if(0===t.length)return"";let s=t[0];for(let i=1;i<t.length;i++)for(;0!==t[i].indexOf(s);)if(s=s.substring(0,s.length-1),""===s)return"";return s}Xt(){if(0===this.wt.length)return this.ut=!1,void("node"===this.Nt&&this.Lt.prompt());this.ut=!0;const t=this.wt.shift();this.config.F||t.Zt?t.ts?this.ss(t.text,t.es):this.ns(t.text,t.es):t.ts?(this.rs(t.text,t.es),this.yt.$t=!0):(this.hs(t.text,t.es),this.yt.$t=!0)}print(t,s=!1,i=!1){return new Promise((e,n)=>{this.wt.push({text:t,Zt:s,ts:i,es:()=>e()}),this.ut||this.Xt()})}Kt(t="",s=!1){return this.print(t+("browser"===this.Nt?"<br>":"\n"),s)}ls(t,s=!1){return this.print(t,s,!0)}cs(){"browser"===this.Nt?this.Yt.innerHTML="":process.stdout.write("[2J[0f")}hs(i,e){let n=0,r=!1,h="",a=[];if("browser"===this.Nt){const t=document.createElement("div");this.Yt.appendChild(t),this.yt.xt=setInterval(()=>{if(n>=i.length)return clearInterval(this.yt.xt),this.yt.xt=null,this.yt.$t=!1,e&&e(),void this.Xt();if("{{instant}}"===i.substring(n,n+11))return r=!0,n+=11,void a.push("instant");if("{{/instant}}"===i.substring(n,n+13))return"instant"===a[a.length-1]&&(a.pop(),r=a.includes("instant")),void(n+=13);if("{"===i.charAt(n)&&"{"===i.charAt(n+1)){const s=i.indexOf("}}",n);if(-1!==s){const e=i.substring(n+2,s).trim().toLowerCase();if("font_reset"===e||"fr"===e)h+="</span>";else if("color_reset"===e)h+="</span>";else if(o.D(e)){const t=o.U(e.replace("#",""));h+=`<span style="color: ${t}">`}else"bold"===e||"thick"===e||"strong"===e||"b"===e?h+="<strong>":"italic"===e||"cursive"===e||"i"===e?h+="<em>":"underline"===e||"u"===e?h+='<span style="text-decoration: underline">':"newline"===e||"n"===e?h+="<br>":"tabulator"!==e&&"tab"!==e&&"t"!==e||(h+="&nbsp;&nbsp;&nbsp;&nbsp;");return n=s+2,void(t.innerHTML=h)}}if(r){const s=i.indexOf("{{/instant}}",n);-1===s?(h+=i.substring(n),t.innerHTML=h,n=i.length):(h+=i.substring(n,s),t.innerHTML=h,n=s)}else h+=i.charAt(n),t.innerHTML=h,n++;this.Yt.scrollTop=this.Yt.scrollHeight},this.config.P)}else this.yt.xt=setInterval(()=>{if(n>=i.length)return clearInterval(this.yt.xt),this.yt.xt=null,this.yt.$t=!1,e&&e(),void this.Xt();if("{{instant}}"===i.substring(n,n+11))return r=!0,n+=11,void a.push("instant");if("{{/instant}}"===i.substring(n,n+13))return"instant"===a[a.length-1]&&(a.pop(),r=a.includes("instant")),void(n+=13);if("{"===i.charAt(n)&&"{"===i.charAt(n+1)){const e=i.indexOf("}}",n);if(-1!==e){const r=i.substring(n+2,e).trim().toLowerCase();if("font_reset"===r||"fr"===r)process.stdout.write(s.reset);else if("color_reset"===r)process.stdout.write(s.reset);else if(o.D(r)){const s=r.replace("#","");t[s]&&process.stdout.write(t[s])}else"bold"===r||"thick"===r||"strong"===r||"b"===r?process.stdout.write(s.bold):"italic"===r||"cursive"===r||"i"===r?process.stdout.write(s.v):"underline"===r||"u"===r?process.stdout.write(s.S):"newline"===r||"n"===r?process.stdout.write("\n"):"tabulator"!==r&&"tab"!==r&&"t"!==r||process.stdout.write("\t");return void(n=e+2)}}if(r){const t=i.indexOf("{{/instant}}",n);-1===t?(process.stdout.write(i.substring(n)),n=i.length):(process.stdout.write(i.substring(n,t)),n=t)}else process.stdout.write(i.charAt(n)),n++},this.config.P)}ns(t,s,i=!0){const e=this.Ot(t);if("browser"===this.Nt){const t=document.createElement("div");t.innerHTML=e,this.Yt.appendChild(t),this.Yt.scrollTop=this.Yt.scrollHeight}else process.stdout.write(e);s&&s(),i&&this.Xt()}fs(t){if("browser"===this.Nt){const s=this.Yt.querySelectorAll("div");if(s.length>0){s[s.length-1].innerHTML=this.Ot(t)}else this.print(t,!0)}else process.stdout.write("[1A[2K"),process.stdout.write(this.Ot(t)+"\n")}us(t,s){const i=t.split("\n");let e=0;const n=()=>{if(e>=i.length)s&&s();else{const t="node"==this.Nt?"\n":"";this.ns(i[e]+t,()=>setTimeout(()=>n(),this.config.P),!1)}e++};n()}rs(t,s){const i=Array.isArray(t),e=i?t[0]:t,n=i?t:[t];if("browser"===this.Nt){const t=o.uuid();this.us(e,()=>{if(!i)return s&&s(),this.yt.$t=!1,void this.Xt();let o=0;const r=e.split("\n").length;this.gt.set(t,{frames:n,ds:0,ps:r,ws:[],es:s});const h=this.Yt.querySelectorAll("div");for(let s=Math.max(0,h.length-r);s<h.length;s++)h[s].classList.add(`lore-animation-${t}`),this.gt.get(t).ws.push(s);const a=setInterval(()=>{o=(o+1)%n.length,this.gs(t,o),this.gt.get(t).ds=o},200);this.bt.set(t,a),this.gt.get(t).es=s,this.Xt()})}else this.us(e,()=>this.Xt())}ss(t,s){const i=Array.isArray(t)?t[0]:t,e="node"==this.Nt?"\n":"";this.ns(e+i+e,()=>this.Xt())}gs(t,s){if(!this.gt.has(t))return;const i=this.gt.get(t),e=i.frames[s].split("\n"),n=this.Yt.querySelectorAll(`.lore-animation-${t}`);for(let t=0;t<Math.min(n.length,e.length);t++)n[t].textContent=e[t];if(e.length>n.length)for(let s=n.length;s<e.length;s++){const n=document.createElement("div");n.textContent=e[s],n.classList.add(`lore-animation-${t}`),this.Yt.appendChild(n),i.ws.push(-1)}for(let t=e.length;t<n.length;t++)n[t].textContent=""}bs(t){if(this.bt.has(t)&&(clearInterval(this.bt.get(t)),this.bt.delete(t)),this.gt.has(t)){const s=this.gt.get(t);s.es&&s.es(),this.gt.delete(t)}}Ct(){if(this.yt.xt&&this.yt.$t)for(clearInterval(this.yt.xt),this.yt.xt=null,this.yt.$t=!1;this.wt.length>0;){const t=this.wt.shift(),s=this.Ot("string"==typeof t.text?t.text:t.text[0]);if("browser"===this.Nt){const t=document.createElement("div");t.innerHTML=s,this.Yt.appendChild(t)}else process.stdout.write(s);t.es&&t.es()}if(this.bt.size>0){for(const[t,s]of this.bt.entries()){clearInterval(s);const i=this.gt.get(t);if(i){const s=i.frames[0];if("browser"===this.Nt){const i=this.Yt.querySelectorAll(`.lore-animation-${t}`),e=s.split("\n");for(let t=0;t<Math.min(i.length,e.length);t++)i[t].textContent=e[t];for(let t=e.length;t<i.length;t++)i[t].remove()}else{const t=s.split("\n");process.stdout.write(`[${i.ps}A`);for(let s=0;s<t.length;s++)process.stdout.write(`[2K${t[s]}\n`);for(let s=t.length;s<i.ps;s++)process.stdout.write("[2K\n")}i.es&&i.es()}}this.bt.clear(),this.gt.clear()}"browser"===this.Nt&&(this.Yt.scrollTop=this.Yt.scrollHeight),this.yt.$t=!1,this.ut=!1}vs(t){"browser"===this.Nt?(this.config.prompt=t,this.At.innerHTML=this.Ot(t)):(this.config.prompt=t,this.Lt.ys(this.Ot(t)),this.Lt.prompt())}start(t){this.$s(this.xs||this.state.it)}$s(t){this.dt=!0,this.state.it=t,this.ks(),"node"===this.Nt?this.Lt.prompt():this.Et.focus()}Ss(){if(this.state={it:null,et:[],flags:{},nt:{},history:[],ot:0},this.cs(),this.Kt("Game restarted."),this.rt.ht.size>0){const t=Array.from(this.rt.ht.keys())[0];this.$s(t)}}move(t){const s=this.rt.ht.get(this.state.it);if(!s||!s.Vt||!s.Vt[t])return this.Kt("You can't go that way."),!1;s.Vt[t];return this._s(t),!0}_s(t){const s=this.rt.ht.get(t);return s?s.Ns&&!s.Ns(this.state)?(this.Kt(s.Is||"You can't go that way right now."),!1):(this.state.it=nextRoomId,this.state.ot++,s.Ys&&s.Ys(this.state,this),void this.ks(!0)):(this.Kt("The path leads nowhere."),!1)}ks(t=!1){const s=this.rt.ht.get(this.state.it);if(s){if(this.Kt(s.name),this.Kt(""),s.image&&(this.ls(s.image),this.Kt("")),this.Kt(s.description),this.Kt(""),!t&&s.Ts&&s.Ts(this.state,this),s.items&&s.items.length>0){const t=s.items.map(t=>{const s=this.rt.items.get(t);return s?s.name:"unknown item"}).join(", ");this.Kt(`You see: ${t}`)}if(s.lt&&s.lt.length>0){const t=s.lt.map(t=>{const s=this.rt.lt.get(t);return s?s.name:"unknown character"}).join(", ");this.Kt(`You see: ${t}`)}if(s.Vt){const t=Object.keys(s.Vt).join(", ");this.Kt(`Exits: ${t}`)}}else this.Kt("You are in the void.")}bs(t){if(this.bt.has(t)&&(clearInterval(this.bt.get(t)),this.bt.delete(t)),this.gt.has(t)&&this.gt.delete(t),"browser"===this.Nt){this.Yt.querySelectorAll(`.lore-animation-${t}`).forEach(t=>t.remove())}}As(){for(const t of this.bt.keys())this.bs(t)}Os(t){const s=this.rt.ht.get(this.state.it);if(!s||!s.items||!s.items.includes(t))return this.Kt("You don't see that here."),!1;const i=this.rt.items.get(t);return i?i.Es?(s.items=s.items.filter(s=>s!==t),this.state.et.push(t),this.Kt(`You take the ${i.name}.`),!0):(this.Kt(`You can't take the ${i.name}.`),!1):(this.Kt("You can't take that."),!1)}Ms(t){const s=this.state.et.indexOf(t);if(-1===s)return this.Kt("You don't have that item."),!1;const i=this.rt.items.get(t);if(!i)return this.Kt("You can't drop that."),!1;const e=this.rt.ht.get(this.state.it);return e?(this.state.et.splice(s,1),e.items||(e.items=[]),e.items.push(t),this.Kt(`You drop the ${i.name}.`),!0):(this.Kt("You can't drop items here."),!1)}js(t,s=null){if(-1===this.state.et.indexOf(t))return this.Kt("You don't have that item."),!1;const i=this.rt.items.get(t);if(!i)return this.Kt("You can't use that."),!1;if(!s)return i.Ps?i.Ps(this.state,this):(this.Kt(`You can't use the ${i.name} that way.`),!1);const e=this.state.et.includes(s),n=this.rt.ht.get(this.state.it),o=n&&n.items&&n.items.includes(s),r=n&&n.lt&&n.lt.includes(s);if(!e&&!o&&!r)return this.Kt("You don't see that here."),!1;let h;return h=r?this.rt.lt.get(s):this.rt.items.get(s),h?i.Ls&&i.Ls[s]?i.Ls[s](this.state,this):h.Fs&&h.Fs[t]?h.Fs[t](this.state,this):(this.Kt(`Using the ${i.name} on the ${h.name} doesn't seem to do anything.`),!1):(this.Kt("You can't use that."),!1)}async confirm(t){return"browser"===this.Nt?(this.Kt(t),this.Kt("1. Yes"),this.Kt("2. No"),new Promise(t=>{const s=i=>{const e=i.trim().toLowerCase();"1"===e||"yes"===e||"y"===e?t(!0):"2"===e||"no"===e||"n"===e?t(!1):(this.fs("Please enter 1 for Yes or 2 for No: "),this.Et.addEventListener("keydown",s,{once:!0}))};this.fs("Select option (1-2): "),this.Et.addEventListener("keydown",s,{once:!0})})):(this.Kt(t),this.Kt("1. Yes"),this.Kt("2. No"),new Promise(s=>{this.Lt.zt("Select option (1-2): ",i=>{const e=i.trim().toLowerCase();"1"===e||"yes"===e||"y"===e?s(!0):"2"===e||"no"===e||"n"===e?s(!1):(this.Kt("Invalid selection. Please try again."),s(this.confirm(t)))})}))}async Gs(t,s){return"browser"===this.Nt?(this.Kt(t),s.forEach((t,s)=>{this.Kt(`${s+1}. ${t}`)}),this.Kt(`${s.length+1}. Cancel`),new Promise(t=>{const i=e=>{const n=parseInt(e.trim(),10);!isNaN(n)&&n>=1&&n<=s.length+1?t(n===s.length+1?-1:n-1):(this.fs(`Please enter a number between 1 and ${s.length+1}: `),this.Et.addEventListener("keydown",i,{once:!0}))};this.fs(`Select option (1-${s.length+1}): `),this.Et.addEventListener("keydown",i,{once:!0})})):(this.Kt(t),s.forEach((t,s)=>{this.Kt(`${s+1}. ${t}`)}),this.Kt(`${s.length+1}. Cancel`),new Promise(i=>{this.Lt.zt(`Select option (1-${s.length+1}): `,e=>{const n=parseInt(e.trim(),10);!isNaN(n)&&n>=1&&n<=s.length+1?i(n===s.length+1?-1:n-1):(this.Kt("Invalid selection. Please try again."),i(this.Gs(t,s)))})}))}Qt(t="default",s=!1){const e={state:{...this.state},timestamp:Date.now(),slot:t};if("browser"===this.Nt){const n=JSON.parse(localStorage.getItem(i)||"{}");n[t]=e,localStorage.setItem(i,JSON.stringify(n)),!s&&this.Kt(`{{green}}Game saved in slot: ${t}{{color_reset}}`)}else{const i=this.path.join(__dirname,"saves");this.Pt.Rs(i)||this.Pt.Cs(i,{Js:!0});const n=this.path.join(i,`save_${t}.json`);this.Pt.Us(n,JSON.stringify(e,null,2)),!s&&this.Kt(`{{green}}Game saved in slot: ${t}{{color_reset}}`)}}Ds(t="default"){try{let s;if("browser"===this.Nt){s=JSON.parse(localStorage.getItem(i)||"{}")[t]}else{const i=this.path.join(__dirname,"saves",`save_${t}.json`);if(!this.Pt.Rs(i))return this.Kt(`No save file found in slot: ${t}`),!1;s=JSON.parse(this.Pt.zs(i,"utf8"))}return s?(this.state=s.state,this.Kt(`Game loaded from slot: ${t}`),this.ks(),!0):(this.Kt(`No save file found in slot: ${t}`),!1)}catch(t){return this.Kt(`Error loading game: ${t.message}`),this.config.debug&&console.error(t),!1}}qs(t="default"){try{if("browser"===this.Nt){const s=JSON.parse(localStorage.getItem(i)||"{}");if(s[t])return delete s[t],localStorage.setItem(i,JSON.stringify(s)),this.Kt(`Save slot ${t} deleted.`),!0}else{const s=this.path.join(__dirname,"saves",`save_${t}.json`);if(this.Pt.Rs(s))return this.Pt.Bs(s),this.Kt(`Save slot ${t} deleted.`),!0}return this.Kt(`No save file found in slot: ${t}`),!1}catch(t){return this.Kt(`Error deleting save: ${t.message}`),this.config.debug&&console.error(t),!1}}Ks(){try{let t={};if("browser"===this.Nt)t=JSON.parse(localStorage.getItem(i)||"{}");else{const s=this.path.join(__dirname,"saves");if(this.Pt.Rs(s)){this.Pt.Hs(s).forEach(i=>{if(i.startsWith("save_")&&i.endsWith(".json")){const e=i.replace("save_","").replace(".json",""),n=this.path.join(s,i),o=JSON.parse(this.Pt.zs(n,"utf8"));t[e]=o}})}}if(0===Object.keys(t).length)return void this.Kt("No save files found.");this.Kt("Available saves:");for(const[s,i]of Object.entries(t)){const t=new Date(i.timestamp);this.Kt(`- ${s}: ${t.toLocaleString()}`)}}catch(t){this.Kt(`Error listing saves: ${t.message}`),this.config.debug&&console.error(t)}}Qs(t){return t.id||(t.id=o.uuid()),this.rt.ht.set(t.id,t),t.id}Vs(t){return t.id||(t.id=o.uuid()),t.Ps=o.B(t.Ps),this.rt.items.set(t.id,t),t.id}Ws(t){return t.id||(t.id=o.uuid()),this.rt.lt.set(t.id,t),t.id}Xs(t){return t.id||(t.id=o.uuid()),this.rt.events.set(t.id,t),t.id}async Zs(t){try{if((t=await this.ti(t)).id&&!this.plugins.has(t.id)){if(this.plugins.set(t.id,t),t.commands)for(const[s,i]of Object.entries(t.commands))this.si(s,i);if(t.ht)for(const s of t.ht)this.Qs(s);if(t.items)for(const s of t.items)this.Vs(s);if(t.lt)for(const s of t.lt)this.Ws(s);if(t.events)for(const s of t.events)this.Xs(s);if(t.ct)for(const[s,i]of Object.entries(t.ct))this.ii(s,i);return this.Kt(`Plugin loaded: ${t.name||t.id}`),!0}return this.Kt("Invalid plugin format: missing id"),!1}catch(t){return this.Kt(`Error loading plugin: ${t.message}`),this.config.debug&&console.error(t),!1}}ei(t){if(this.plugins.has(t)){const s=this.plugins.get(t);if(s.commands)for(const t of Object.keys(s.commands))this.rt.commands.delete(t);if(s.ht)for(const t of s.ht)this.rt.ht.delete(t.id);if(s.items)for(const t of s.items)this.rt.items.delete(t.id);if(s.lt)for(const t of s.lt)this.rt.lt.delete(t.id);if(s.events)for(const t of s.events)this.rt.events.delete(t.id);if(s.ct)for(const t of Object.keys(s.ct))this.rt.ct.delete(t);return this.plugins.delete(t),this.Kt(`Plugin unloaded: ${t}`),!0}return this.Kt(`Plugin not found: ${t}`),!1}async ni(t){try{if(t=await this.ti(t),this.theme={...e,...t},"browser"===this.Nt){for(const[t,s]of Object.entries(this.theme))document.documentElement.style.setProperty(t,s);this.It.style.backgroundColor=this.theme["N"],this.It.style.color=this.theme["I"],this.It.style.fontFamily=this.theme["A"],this.It.style.fontSize=this.theme["O"],this.At.style.color=this.theme["Y"],this.Et.style.color=this.theme["T"],this.theme["oi"]&&this.vs(this.theme["oi"])}else this.theme["oi"]&&this.vs(this.theme["oi"]);return!0}catch(t){return this.Kt(`Error loading theme: ${t.message}`),this.config.debug&&console.error(t),!1}}async ti(t){if("string"==typeof t&&o.q(t)){if(!t.endsWith(".js"))return this.Kt("{{red}}Module loaded from URL must be a JavaScript (.js) file{{color_reset}}"),{};try{t="browser"===this.Nt?await o.K(t):require(t)}catch(t){return this.Kt(`{{red}}Couldn't prepare module\n${t.message}`),{}}}return"string"==typeof t&&(t=JSON.parse(novel)),t}ri(){this.Kt("{{bold}}Available commands:{{font_reset}}");Array.from(this.rt.commands).map(t=>t[1]).sort((t,s)=>t.weight-s.weight).filter(t=>t.hi&&-1!=t.weight).forEach(t=>{const s=t.display||t.name,i=t.ai&&t.ai.length?", "+t.ai.join(", "):"",e=t.hi;this.Kt(`  {{green}}${s}{{color_reset}}{{green}}${i}{{color_reset}} - ${e}`)})}si(t){t&&t.name&&this.rt.commands.set(t.name.toLowerCase(),{name:"foo",ai:[],Ht:()=>{},hi:"",weight:null,...t})}ii(t,s){this.rt.ct.set(t,s)}_t(){this.si({name:"help",ai:["h","?"],Ht:()=>this.ri(),hi:"Show this help",weight:1e3}),this.si({name:"look",ai:["l","see"],Ht:()=>this.ks(),hi:"Look around the current room",weight:1}),this.si({name:"go",display:"go [dir]",Ht:(t,s)=>{0!==t.length?s.move(t[0]):s.Kt("Go where?")},hi:"Move in a direction",weight:2});const t=["north","south","east","west","northeast","northwest","southeast","southwest","up","down","in","out"],s=["n","s","e","w","ne","nw","se","sw","u","d","i","o"];for(let i=0;i<t.length;i++){const e=t[i],n=s[i];this.si({name:e,ai:[n],Ht:t=>t.move(e),hi:null,weight:-1})}this.si({name:"take",display:"take [item]",Ht:(t,s)=>{if(0===t.length)return void s.Kt("Take what?");const i=s.rt.ht.get(s.state.it);if(!i||!i.items)return void s.Kt("There's nothing to take here.");const e=t.join(" ").toLowerCase();let n=null;for(const t of i.items){const i=s.rt.items.get(t);if(i&&i.name.toLowerCase().includes(e)){n=t;break}}n?s.Os(n):s.Kt("You don't see that here.")},hi:"Take an item",weight:3}),this.si({name:"drop",display:"drop [item]",Ht:(t,s)=>{if(0===t.length)return void s.Kt("Drop what?");const i=t.join(" ").toLowerCase();let e=null;for(const t of s.state.et){const n=s.rt.items.get(t);if(n&&n.name.toLowerCase().includes(i)){e=t;break}}e?s.Ms(e):s.Kt("You don't have that item.")},hi:"Drop an item",weight:4}),this.si({name:"inventory",ai:["i"],Ht:(t,s)=>{if(0!==s.state.et.length){s.Kt("{{bold}}You are carrying:{{font_reset}}");for(const t of s.state.et){const i=s.rt.items.get(t);i&&s.Kt(`- ${i.name}`)}}else s.Kt("You are carrying nothing.")},hi:"Show your inventory",weight:5}),this.si({name:"use",display:"use [item]",Ht:(t,s)=>{if(0===t.length)return void s.Kt("Use what?");const i=t.findIndex(t=>"on"===t);let e,n=null;-1!==i?(e=t.slice(0,i).join(" ").toLowerCase(),n=t.slice(i+1).join(" ").toLowerCase()):e=t.join(" ").toLowerCase();let o=null;for(const t of s.state.et){const i=s.rt.items.get(t);if(i&&i.name.toLowerCase().includes(e)){o=t;break}}if(o)if(n){const t=s.rt.ht.get(s.state.it);let i=null;if(t&&t.items)for(const e of t.items){const t=s.rt.items.get(e);if(t&&t.name.toLowerCase().includes(n)){i=e;break}}if(!i&&t&&t.lt)for(const e of t.lt){const t=s.rt.lt.get(e);if(t&&t.name.toLowerCase().includes(n)){i=e;break}}if(!i)for(const t of s.state.et){const e=s.rt.items.get(t);if(e&&e.name.toLowerCase().includes(n)){i=t;break}}i?s.js(o,i):s.Kt("You don't see that here.")}else s.js(o);else s.Kt("You don't have that item.")},hi:"Use an item",weight:6}),this.si({name:"say",display:"say [...]",Ht:(t,s)=>{if(0===t.length)return void s.Kt("You don't say");const i=t.join(" ");s.Kt(`You say:{{n}} - ${i}`)},weight:7,hi:"Say something"}),this.si({name:"talk",display:"talk [character]",Ht:(t,s)=>{if(0===t.length)return void s.Kt("Talk to whom?");const i=s.rt.ht.get(s.state.it);if(!i||!i.lt)return void s.Kt("There's no one here to talk to.");const e=t.join(" ").toLowerCase();let n=null;for(const t of i.lt){const i=s.rt.lt.get(t);if(i&&i.name.toLowerCase().includes(e)){n=t;break}}if(n){const t=s.rt.lt.get(n);t.li?t.li(s.state,s):s.Kt(`${t.name} has nothing to say to you.`)}else s.Kt("You don't see that person here.")},hi:"Talk to someone",weight:8}),this.si({name:"save",display:"save [slot]",Ht:(t,s)=>{const i=t.length>0?t[0]:"default";s.Qt(i)},hi:"Save the game",weight:9}),this.si({name:"load",display:"load [slot]",Ht:(t,s)=>{const i=t.length>0?t[0]:"default";s.Ds(i)},hi:"Load a saved game",weight:10}),this.si({name:"restart",Ht:()=>this.Ss(),hi:"Restart the game",weight:11}),this.si({name:"quit",ai:["exit"],Ht:(t,s)=>{s.Kt("{{green}}Goodbye!{{color_reset}}"),"node"===s.Nt?s.Lt.close():(s.As(),s.state={it:null,et:[],flags:{},nt:{},history:[],ot:0},s.cs())},hi:"Quit the game",weight:999})}async ci(t){try{t=await this.ti(t),this.rt.ht.clear(),this.rt.items.clear(),this.rt.lt.clear(),this.rt.events.clear();const s=new Map(this.rt.commands),i=new Map(this.rt.ct);if(this.rt.commands=s,this.rt.ct=i,t.ht)for(const s of t.ht)this.Qs(s);if(t.items)for(const s of t.items)this.Vs(s);if(t.lt)for(const s of t.lt)this.Ws(s);if(t.events)for(const s of t.events)this.Xs(s);return t.fi?this.state.it=t.fi:this.state.it=null,this.config.L&&this.cs(),this.$s(this.state.it),!0}catch(t){return this.Kt(`Error loading novel: ${t.message}`),this.config.debug&&console.error(t),!1}}},ui:o}});