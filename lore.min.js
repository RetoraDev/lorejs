/**
* Copyright 2025 RetoraDev
*
*   Licensed under the Apache License, Version 2.0 (the "License");
*   you may not use this file except in compliance with the License.
*   You may obtain a copy of the License at
*
*       http://www.apache.org/licenses/LICENSE-2.0
*
*   Unless required by applicable law or agreed to in writing, software
*   distributed under the License is distributed on an "AS IS" BASIS,
*   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
*   See the License for the specific language governing permissions and
*   limitations under the License.
*/

!function(t,e){"object"==typeof module&&"object"==typeof module.exports?module.exports=e():t.LORE=e()}("undefined"!=typeof window?window:this,function(){"use strict";const t={black:"[30m",red:"[31m",green:"[32m",yellow:"[33m",blue:"[34m",magenta:"[35m",cyan:"[36m",white:"[37m",reset:"[0m"},e={reset:"[0m",bold:"[1m",thick:"[1m",strong:"[1m",b:"[1m",italic:"[3m",cursive:"[3m",i:"[3m",underline:"[4m",u:"[4m",blink:"[5m",inverse:"[7m",hidden:"[8m"},i="lore_save_data",n={"--lore-bg-color":"#000000","--lore-text-color":"#ffffff","--lore-prompt-color":"#00ff00","--lore-input-color":"#ffffff","--lore-font-family":"monospace","--lore-font-size":"16px","--lore-border-color":"#333333"},s={prompt:"> ",autosave:!1,typingSpeed:30,debug:!1,clearScreenOnNovelLoad:!0,disableTextAnimation:!1},o={isBrowser:"undefined"!=typeof window&&"undefined"!=typeof document,isNode:"undefined"!=typeof process&&process.versions&&process.versions.node,deepClone:t=>({...t}),uuid:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){const e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)}),debounce(t,e){let i;return function(...n){clearTimeout(i),i=setTimeout(()=>{clearTimeout(i),t(...n)},e)}},colorNameToHex:t=>({black:"#000000",red:"#ff0000",green:"#00ff00",yellow:"#ffff00",blue:"#0000ff",magenta:"#ff00ff",cyan:"#00ffff",white:"#ffffff"}[t.toLowerCase()]||t),isValidColor(t){if(!t)return!1;return!!["black","red","green","yellow","blue","magenta","cyan","white"].includes(t.toLowerCase())||/^#?([0-9A-F]{3}){1,2}$/i.test(t)},isURL:t=>t.startsWith("file://")||t.startsWith("./")||t.startsWith("../")||t.startsWith("http://")||t.startsWith("https://"),deserializeFunction:t=>"string"==typeof t?new Function(`const state = arguments[0]; const engine = arguments[1]; ${t}`):t,arraysEqual(t,e){if(t===e)return!0;if(null==t||null==e)return!1;if(t.length!==e.length)return!1;for(let i=0;i<t.length;++i)if(t[i]!==e[i])return!1;return!0},async loadModule(t){try{const e=await fetch(t),i=await e.text();if(!e.ok)return console.error("File at",t,"not found!"),{};return new Function(`\n            const module = {\n              exports: {}\n            };\n            try {\n              ${i}\n            } catch(error) {\n              return module;\n              throw error;\n            }\n            return module;\n          `)().exports}catch(e){return console.error("Error loading module from ",t,e),{}}}};return{ANSI_COLORS:t,ANSI_STYLES:e,VERSION:"1.0.3",STORAGE_KEY:i,DEFAULT_PROMPT:"> ",DEFAULT_THEME:n,DEFAULT_CONFIG:s,Game:class{constructor(t={}){this.state={currentRoom:null,inventory:[],flags:{},variables:{},history:[],gameTime:0},this.config={...s,...t},this.world={rooms:new Map,items:new Map,characters:new Map,events:new Map,commands:new Map,aliases:new Map,keybindings:new Map},this.plugins=new Map,this.theme={...n},this.historyIndex=-1,this.queueIsRunning=!1,this.isRunning=!1,this.outputQueue=[],this.outputBuffer=[],this.animationFrames=new Map,this.animationIntervals=new Map,this._completionState=null,this._nodeCompletionState=null,this.formattingState={color:null,bold:!1,italic:!1,underline:!1},this.animationState={isAnimating:!1,currentAnimation:null},o.isBrowser?this.initBrowser():o.isNode&&this.initNode(),this.registerDefaultCommands()}initBrowser(){this.env="browser",this.terminalElement=document.createElement("div"),this.terminalElement.className="lore-terminal",this.terminalElement.style.cssText=`\n          position: fixed;\n          top: 0;\n          left: 0;\n          width: 100%;\n          height: 100%;\n          background-color: ${this.theme["--lore-bg-color"]};\n          color: ${this.theme["--lore-text-color"]};\n          font-family: ${this.theme["--lore-font-family"]};\n          font-size: ${this.theme["--lore-font-size"]};\n          overflow: auto;\n          padding: 20px;\n          box-sizing: border-box;\n        `,this.outputElement=document.createElement("div"),this.outputElement.className="lore-output",this.outputElement.style.cssText="\n          height: calc(100% - 60px);\n          overflow-y: auto;\n          margin-bottom: 20px;\n          white-space: pre-wrap;\n        ",this.inputContainer=document.createElement("div"),this.inputContainer.className="lore-input-container",this.inputContainer.style.cssText="\n          display: flex;\n          align-items: center;\n          background: transparent;\n        ",this.promptElement=document.createElement("span"),this.promptElement.className="lore-prompt",this.promptElement.textContent=this.parseFormatting(this.config.prompt),this.inputElement=document.createElement("input"),this.inputElement.className="lore-input",this.inputElement.type="text",this.inputElement.style.cssText=`\n          flex: 1;\n          background: transparent;\n          border: none;\n          outline: none;\n          color: ${this.theme["--lore-input-color"]};\n          font-family: ${this.theme["--lore-font-family"]};\n          font-size: ${this.theme["--lore-font-size"]};\n          margin-left: 5px;\n        `,this.inputContainer.appendChild(this.promptElement),this.inputContainer.appendChild(this.inputElement),this.terminalElement.appendChild(this.outputElement),this.terminalElement.appendChild(this.inputContainer),document.querySelector(".lore-terminal")||(document.body.appendChild(this.terminalElement),document.body.style.margin="0",document.body.style.padding="0"),this.setupBrowserEvents()}initNode(){this.env="node",this.readline=require("readline"),this.fs=require("fs"),this.path=require("path"),this.rl=this.readline.createInterface({input:process.stdin,output:process.stdout,prompt:this.parseFormatting(this.config.prompt)}),this.setupNodeEvents()}setupBrowserEvents(){this.inputElement.addEventListener("keydown",t=>{"Enter"===t.key?this.animationState.isAnimating?(this.skipAnimation(),t.preventDefault()):(this.processInput(this.inputElement.value),this.inputElement.value="",t.preventDefault()):"ArrowUp"===t.key?(this.navigateHistory(-1),t.preventDefault()):"ArrowDown"===t.key?(this.navigateHistory(1),t.preventDefault()):"Tab"===t.key||"ArrowRight"===t.key?(this.autoComplete(),t.preventDefault()):"Escape"===t.key&&this.animationState.isAnimating&&(this.skipAnimation(),t.preventDefault())}),window.addEventListener("resize",o.debounce(()=>{this.outputElement.scrollTop=this.outputElement.scrollHeight},250)),this.terminalElement.addEventListener("click",()=>{this.inputElement.focus()}),this.inputElement.addEventListener("dblclick",t=>{this.autoComplete(),t.preventDefault()})}setupNodeEvents(){this.rl.on("line",t=>{this.animationState.isAnimating?(this.skipAnimation(),this.rl.prompt()):(this.processInput(t),this.rl.prompt())}).on("close",()=>{process.exit(0)}),process.stdin.isTTY&&(process.stdin.setRawMode(!0),process.stdin.on("data",t=>{if(1===t.length&&9===t[0]){const t=this.rl.line,[e,i]=this.readlineCompleter(t);return void(e.length>0&&i!==t&&(this.rl.line=i,this.rl.cursor=i.length,this.rl._refreshLine()))}1!==t.length||3!==t[0]||this.rl.emit("SIGINT")})),this.rl.on("SIGINT",()=>{this.animationState.isAnimating?(this.skipAnimation(),this.rl.prompt()):this.rl.question("Are you sure you want to exit? (y/n) ",t=>{t.match(/^y(es)?$/i)?this.rl.close():this.rl.prompt()})})}parseFormatting(t){return"browser"===this.env?this.parseFormattingBrowser(t):this.parseFormattingNode(t)}parseFormattingBrowser(t){const e=/\{\{([^}]+)\}\}/g;let i,n=0,s="";for(this.formattingState={color:null,bold:!1,italic:!1,underline:!1};null!==(i=e.exec(t));){s+=t.substring(n,i.index),n=i.index+i[0].length;const e=i[1].trim().toLowerCase();s+=this.processSingleTag(e)}return s+=t.substring(n),this.formattingState.underline&&(s+="</span>"),this.formattingState.italic&&(s+="</em>"),this.formattingState.bold&&(s+="</strong>"),this.formattingState.color&&(s+="</span>"),s}parseFormattingNode(t){const i=/\{\{([^}]+)\}\}/g;let n,s=0,o="";for(this.formattingState={color:null,bold:!1,italic:!1,underline:!1};null!==(n=i.exec(t));){o+=t.substring(s,n.index),s=n.index+n[0].length;const e=n[1].trim().toLowerCase();o+=this.processSingleTag(e)}return o+=t.substring(s),(this.formattingState.color||this.formattingState.bold||this.formattingState.italic||this.formattingState.underline)&&(o+=e.reset),o}processSingleTag(i){let n="";if("browser"===this.env)if("font_reset"===i||"fr"===i)n+="</span>",this.formattingState={color:null,bold:!1,italic:!1,underline:!1};else if("color_reset"===i)this.formattingState.color&&(n+="</span>",this.formattingState.color=null);else if(o.isValidColor(i)){this.formattingState.color&&(n+="</span>");const t=o.colorNameToHex(i.replace("#",""));n+=`<span style="color: ${t}">`,this.formattingState.color=t}else"bold"===i||"thick"===i||"strong"===i||"b"===i?this.formattingState.bold||(n+='<span style="font-weight: bold">',this.formattingState.bold=!0):"italic"===i||"cursive"===i||"i"===i?this.formattingState.italic||(n+='<span style="font-style: italic">',this.formattingState.italic=!0):"underline"===i||"u"===i?this.formattingState.underline||(n+='<span style="text-decoration: underline">',this.formattingState.underline=!0):"newline"===i||"n"===i?n+="<br>":"double_newline"===i||"dn"===i?n+="<br><br>":"tabulator"===i||"tab"===i||"t"===i?n+="&nbsp;&nbsp;&nbsp;&nbsp;":"instant"===i&&(n+="");else if("font_reset"===i||"fr"===i)n+=e.reset,this.formattingState={color:null,bold:!1,italic:!1,underline:!1};else if("color_reset"===i)(this.formattingState.color||this.formattingState.bold||this.formattingState.italic||this.formattingState.underline)&&(n+=e.reset,this.formattingState={color:null,bold:!1,italic:!1,underline:!1});else if(o.isValidColor(i)){const e=i.replace("#","");t[e]&&(n+=t[e],this.formattingState.color=e)}else"bold"===i||"thick"===i||"strong"===i||"b"===i?this.formattingState.bold||(n+=e.bold,this.formattingState.bold=!0):"italic"===i||"cursive"===i||"i"===i?this.formattingState.italic||(n+=e.italic,this.formattingState.italic=!0):"underline"===i||"u"===i?this.formattingState.underline||(n+=e.underline,this.formattingState.underline=!0):"newline"===i||"n"===i?n+="\n":"double_newline"===i||"dn"===i?n+="\n\n":"tabulator"===i||"tab"===i||"t"===i?n+="\t":"instant"===i&&(n+="");return n}processInput(t){if(!t.trim())return;if(this._completionState=null,this._nodeCompletionState=null,this.animationState.currentAnimation||this.queueIsRunning)return void this.skipAnimation();this.state.history.push(t),this.historyIndex=this.state.history.length,"browser"===this.env&&this.printLine(`${this.config.prompt}${t}`,!0);const[e,...i]=t.trim().split(/\s+/);let n=e.toLowerCase(),s=!0;if(this.world.commands.has(n)||(this.world.aliases.has(n)?n=this.world.aliases.get(n):s=!1),s)try{const t=this.world.commands.get(n);t?.fn?.call(this,i,this)}catch(t){this.printLine(`Error executing command: ${t.message}`),this.config.debug&&console.error(t)}else this.printLine(`Unknown command: ${e}. Type 'help' for available commands.`);this.config.autosave&&this.saveGame("autosave",!0)}navigateHistory(t){if(0!==this.state.history.length){if(this._completionState=null,this._nodeCompletionState=null,this.historyIndex+=t,this.historyIndex<0)this.historyIndex=0;else if(this.historyIndex>=this.state.history.length)return this.historyIndex=this.state.history.length,void(this.inputElement.value="");this.inputElement.value=this.state.history[this.historyIndex]}}autoComplete(t){if(!t){if("browser"!==this.env)return;t=this.inputElement.value.trim()}if(!t)return;const e=t.split(" "),i=e[e.length-1].toLowerCase(),n=this.getCompletions(i,e,e.length).filter(t=>t.toLowerCase().startsWith(i.toLowerCase()));if(1===n.length)e[e.length-1]=n[0],"browser"===this.env&&(this.inputElement.value=e.join(" "));else if(n.length>1){this._completionState?this._completionState.currentIndex=(this._completionState.currentIndex+1)%n.length:this._completionState={originalInput:t,matches:n,currentIndex:-1};const i=n[this._completionState.currentIndex];e[e.length-1]=i,"browser"===this.env&&(this.inputElement.value=e.join(" ")),this._completionState.currentIndex,n.length}else this._completionState=null}readlineCompleter(t){const e=t.trim().split(/\s+/),i=e[e.length-1]||"",n=this.getCompletions(i,e,e.length).filter(t=>t.toLowerCase().startsWith(i.toLowerCase()));if(n.length>0){this._nodeCompletionState&&this._nodeCompletionState.originalLine===t&&o.arraysEqual(this._nodeCompletionState.hits,n)||(this._nodeCompletionState={originalLine:t,hits:n,currentIndex:-1}),this._nodeCompletionState.currentIndex=(this._nodeCompletionState.currentIndex+1)%n.length;const i=n[this._nodeCompletionState.currentIndex],s=e.slice(0,-1).concat(i).join(" ");return[[s],s]}return[[t],t]}getCompletions(t,e,i){const n=new Set;for(const[t,e]of this.world.commands)-1!==e.weight&&(n.add(t),e.aliases&&e.aliases.forEach(t=>n.add(t)));const s=this.world.rooms.get(this.state.currentRoom);if(s&&(s.exits&&Object.keys(s.exits).forEach(t=>n.add(t)),s.items&&s.items.forEach(t=>{const e=this.world.items.get(t);e&&(n.add(e.name.toLowerCase()),e.aliases&&e.aliases.forEach(t=>n.add(t.toLowerCase())))}),s.characters&&s.characters.forEach(t=>{const e=this.world.characters.get(t);e&&(n.add(e.name.toLowerCase()),e.aliases&&e.aliases.forEach(t=>n.add(t.toLowerCase())),1===s.characters.length&&e.genre&&("female"===e.genre?(n.add("her"),n.add("she")):"male"===e.genre&&(n.add("him"),n.add("he"))))})),this.state.inventory.forEach(t=>{const e=this.world.items.get(t);e&&(n.add(e.name.toLowerCase()),e.aliases&&e.aliases.forEach(t=>n.add(t.toLowerCase())))}),i>=3&&"talk"===e[0]&&s&&s.characters){const t=e[1].toLowerCase();for(const e of s.characters){const i=this.world.characters.get(e);if(i&&(i.name.toLowerCase().includes(t)||i.aliases&&i.aliases.some(e=>e.toLowerCase().includes(t)))){i.topics&&(Object.keys(i.topics).forEach(t=>n.add(t)),Object.values(i.topics).forEach(t=>{t.aliases&&t.aliases.forEach(t=>n.add(t))}));break}}}if("go"===e[0]&&2===i){const t=["n","s","e","w","ne","nw","se","sw","u","d","i","o"];["north","south","east","west","northeast","northwest","southeast","southwest","up","down","in","out"].forEach(t=>n.add(t)),t.forEach(t=>n.add(t))}return"save"!==e[0]&&"load"!==e[0]&&"delete"!==e[0]||2!==i||(n.add("default"),n.add("autosave"),n.add("slot1"),n.add("slot2"),n.add("slot3")),Array.from(n).sort()}findCommonPrefix(t){if(0===t.length)return"";let e=t[0];for(let i=1;i<t.length;i++)for(;0!==t[i].indexOf(e);)if(e=e.substring(0,e.length-1),""===e)return"";return e}processOutputQueue(){if(0===this.outputQueue.length)return this.queueIsRunning=!1,void("node"===this.env&&this.rl.prompt());this.queueIsRunning=!0;const t=this.outputQueue.shift();this.config.disableTextAnimation||t.instant?t.img?this.printImageInstantly(t.text,t.callback):this.printInstantly(t.text,t.callback):t.img?(this.animateImage(t.text,t.callback),this.animationState.isAnimating=!0):(this.animateText(t.text,t.callback),this.animationState.isAnimating=!0)}print(t,e=!1,i=!1){return new Promise((n,s)=>{this.outputQueue.push({text:t,instant:e,img:i,callback:()=>n()}),this.queueIsRunning||this.processOutputQueue()})}printLine(t="",e=!1){return this.print(t+("browser"===this.env?"{{instant}}<br>{{/instant}}":"\n"),e)}printImg(t,e=!1){return this.print(t,e,!0)}clearScreen(){"browser"===this.env?this.outputElement.innerHTML="":process.stdout.write("[2J[0f")}animateText(t,e){let i=0,n=!1,s="",o=[];if("browser"===this.env){const r=document.createElement("div");this.outputElement.appendChild(r),this.animationState.currentAnimation=setInterval(()=>{if(i>=t.length)return clearInterval(this.animationState.currentAnimation),this.animationState.currentAnimation=null,this.animationState.isAnimating=!1,e&&e(),void this.processOutputQueue();if("{{instant}}"===t.substring(i,i+11))return n=!0,i+=11,void o.push("instant");if("{{/instant}}"===t.substring(i,i+13))return"instant"===o[o.length-1]&&(o.pop(),n=o.includes("instant")),void(i+=13);if("{"===t.charAt(i)&&"{"===t.charAt(i+1)){const e=t.indexOf("}}",i);if(-1!==e){const n=t.substring(i+2,e).trim().toLowerCase();return s+=this.processSingleTag(n),i=e+2,void(r.innerHTML=s)}}if(n){const e=t.indexOf("{{/instant}}",i);-1===e?(s+=t.substring(i),r.innerHTML=s,i=t.length):(s+=t.substring(i,e),r.innerHTML=s,i=e)}else s+=t.charAt(i),r.innerHTML=s,i++;this.outputElement.scrollTop=this.outputElement.scrollHeight},this.config.typingSpeed)}else this.animationState.currentAnimation=setInterval(()=>{if(i>=t.length)return clearInterval(this.animationState.currentAnimation),this.animationState.currentAnimation=null,this.animationState.isAnimating=!1,e&&e(),void this.processOutputQueue();if("{{instant}}"===t.substring(i,i+11))return n=!0,i+=11,void o.push("instant");if("{{/instant}}"===t.substring(i,i+13))return"instant"===o[o.length-1]&&(o.pop(),n=o.includes("instant")),void(i+=13);if("{"===t.charAt(i)&&"{"===t.charAt(i+1)){const e=t.indexOf("}}",i);if(-1!==e){const n=t.substring(i+2,e).trim().toLowerCase();return process.stdout.write(this.processSingleTag(n)),void(i=e+2)}}if(n){const e=t.indexOf("{{/instant}}",i);-1===e?(process.stdout.write(t.substring(i)),i=t.length):(process.stdout.write(t.substring(i,e)),i=e)}else process.stdout.write(t.charAt(i)),i++},this.config.typingSpeed)}printInstantly(t,e,i=!0){const n=this.parseFormatting(t);if("browser"===this.env){const t=document.createElement("div");t.innerHTML=n,this.outputElement.appendChild(t),this.outputElement.scrollTop=this.outputElement.scrollHeight}else process.stdout.write(n);e&&e(),i&&this.processOutputQueue()}updateLastLine(t){if("browser"===this.env){const e=this.outputElement.querySelectorAll("div");if(e.length>0){e[e.length-1].innerHTML=this.parseFormatting(t)}else this.print(t,!0)}else process.stdout.write("[1A[2K"),process.stdout.write(this.parseFormatting(t)+"\n")}printTextLineByLine(t,e){const i=t.split("\n");let n=0;const s=()=>{if(n>=i.length)e&&e();else{const t="node"==this.env?"\n":"";this.printInstantly(i[n]+t,()=>setTimeout(()=>s(),this.config.typingSpeed),!1)}n++};s()}animateImage(t,e){const i=Array.isArray(t),n=i?t[0]:t,s=i?t:[t];if("browser"===this.env){const t=o.uuid();this.printTextLineByLine(n,()=>{if(!i)return e&&e(),this.animationState.isAnimating=!1,void this.processOutputQueue();let o=0;const r=n.split("\n").length;this.animationFrames.set(t,{frames:s,currentFrame:0,totalLines:r,elementIds:[],callback:e});const a=this.outputElement.querySelectorAll("div");for(let e=Math.max(0,a.length-r);e<a.length;e++)a[e].classList.add(`lore-animation-${t}`),this.animationFrames.get(t).elementIds.push(e);const l=setInterval(()=>{o=(o+1)%s.length,this.updateAnimation(t,o),this.animationFrames.get(t).currentFrame=o},200);this.animationIntervals.set(t,l),this.animationFrames.get(t).callback=e,this.processOutputQueue()})}else this.printTextLineByLine(n,()=>this.processOutputQueue())}printImageInstantly(t,e){const i=Array.isArray(t)?t[0]:t,n="node"==this.env?"\n":"";this.printInstantly(n+i+n,()=>this.processOutputQueue())}updateAnimation(t,e){if(!this.animationFrames.has(t))return;const i=this.animationFrames.get(t),n=i.frames[e].split("\n"),s=this.outputElement.querySelectorAll(`.lore-animation-${t}`);for(let t=0;t<Math.min(s.length,n.length);t++)s[t].textContent=n[t];if(n.length>s.length)for(let e=s.length;e<n.length;e++){const s=document.createElement("div");s.textContent=n[e],s.classList.add(`lore-animation-${t}`),this.outputElement.appendChild(s),i.elementIds.push(-1)}for(let t=n.length;t<s.length;t++)s[t].textContent=""}stopAnimation(t){if(this.animationIntervals.has(t)&&(clearInterval(this.animationIntervals.get(t)),this.animationIntervals.delete(t)),this.animationFrames.has(t)){const e=this.animationFrames.get(t);e.callback&&e.callback(),this.animationFrames.delete(t)}}skipAnimation(){if(this.animationState.currentAnimation&&this.animationState.isAnimating)for(clearInterval(this.animationState.currentAnimation),this.animationState.currentAnimation=null,this.animationState.isAnimating=!1;this.outputQueue.length>0;){const t=this.outputQueue.shift(),e=this.parseFormatting("string"==typeof t.text?t.text:t.text[0]);if("browser"===this.env){const t=document.createElement("div");t.innerHTML=e,this.outputElement.appendChild(t)}else process.stdout.write(e);t.callback&&t.callback()}if(this.animationIntervals.size>0){for(const[t,e]of this.animationIntervals.entries()){clearInterval(e);const i=this.animationFrames.get(t);if(i){const e=i.frames[0];if("browser"===this.env){const i=this.outputElement.querySelectorAll(`.lore-animation-${t}`),n=e.split("\n");for(let t=0;t<Math.min(i.length,n.length);t++)i[t].textContent=n[t];for(let t=n.length;t<i.length;t++)i[t].remove()}else{const t=e.split("\n");process.stdout.write(`[${i.totalLines}A`);for(let e=0;e<t.length;e++)process.stdout.write(`[2K${t[e]}\n`);for(let e=t.length;e<i.totalLines;e++)process.stdout.write("[2K\n")}i.callback&&i.callback()}}this.animationIntervals.clear(),this.animationFrames.clear()}"browser"===this.env&&(this.outputElement.scrollTop=this.outputElement.scrollHeight),this.animationState.isAnimating=!1,this.queueIsRunning=!1}updatePrompt(t){"browser"===this.env?(this.config.prompt=t,this.promptElement.innerHTML=this.parseFormatting(t)):(this.config.prompt=t,this.rl.setPrompt(this.parseFormatting(t)),this.rl.prompt())}start(t){this.startGame(this.startRoomId||this.state.currentRoom)}startGame(t){this.isRunning=!0,this.state.currentRoom=t,this.look(),"node"===this.env?this.rl.prompt():this.inputElement.focus()}restartGame(){if(this.state={currentRoom:null,inventory:[],flags:{},variables:{},history:[],gameTime:0},this.clearScreen(),this.printLine("Game restarted."),this.world.rooms.size>0){const t=Array.from(this.world.rooms.keys())[0];this.startGame(t)}}move(t){const e=this.world.rooms.get(this.state.currentRoom);if(!e||!e.exits||!e.exits[t])return this.printLine("You can't go that way."),!1;const i=e.exits[t];return this.enterRoom(i),!0}enterRoom(t){const e=this.world.rooms.get(t);return e?e.condition&&!e.condition(this.state)?(this.printLine(e.blockedMessage||"You can't go that way right now."),!1):(this.state.currentRoom=e.id,this.state.gameTime++,e.onEnter&&e.onEnter(this.state,this),this.look(!0),!0):(this.printLine("The path leads nowhere."),!1)}look(t=!1){const e=this.world.rooms.get(this.state.currentRoom);if(e){if(e.name&&e.name.length&&(this.printLine(e.name),this.printLine("")),e.image&&(this.printImg(e.image),this.printLine("")),e.description&&e.description.length&&(this.printLine(e.description),this.printLine("")),!t&&e.onLook&&e.onLook(this.state,this),e.items&&e.items.length>0){const t=e.items.map(t=>{const e=this.world.items.get(t);return e?e.name:"unknown item"}).join(", ");this.printLine(`You see: ${t}`)}if(e.characters&&e.characters.length>0){const t=e.characters.map(t=>{const e=this.world.characters.get(t);return e?e.name:"unknown character"}).join(", ");this.printLine(`You see: ${t}`)}(e.tutorial||e.tutorials)&&(this.printLine(""),"string"==typeof e.tutorial?this.printTutorial(e.tutorial):"object"!=typeof e.tutorial&&"object"!=typeof e.tutorials||(e.tutorial||e.tutorials).forEach(t=>{this.printTutorial(t)}),e.keepTutorials||(delete e.tutorial,delete e.tutorials))}else this.printLine("You are in the void.")}printRoomExits(t){if(!t)return!1;if(t.exits){let e="";Object.keys(t.exits).forEach(t=>e+=` - ${t}{{n}}`),this.printLine(`Where would you like to go?\n${e}`)}else this.printLine("You don't see how to exit");return!0}printTutorial(t){const e=this.world.commands.get(t);e&&e.purpose&&this.printLine(`Type {{bold}}${e.name}{{font_reset}} to ${e.purpose}.`)}stopAnimation(t){if(this.animationIntervals.has(t)&&(clearInterval(this.animationIntervals.get(t)),this.animationIntervals.delete(t)),this.animationFrames.has(t)&&this.animationFrames.delete(t),"browser"===this.env){this.outputElement.querySelectorAll(`.lore-animation-${t}`).forEach(t=>t.remove())}}stopAllAnimations(){for(const t of this.animationIntervals.keys())this.stopAnimation(t)}lockRoom(t,e,i="The way is blocked."){const n=this.world.rooms.get(t);return!!n&&(n.condition=e,n.blockedMessage=i,!0)}unlockRoom(t){const e=this.world.rooms.get(t);return!!e&&(e.condition=null,e.blockedMessage=null,!0)}isRoomLocked(t){const e=this.world.rooms.get(t);return e&&e.condition&&!e.condition(this.state)}takeItem(t){const e=this.world.rooms.get(this.state.currentRoom);if(!e||!e.items||!e.items.includes(t))return this.printLine("You don't see that here."),!1;const i=this.world.items.get(t);return i?i.takeable?(e.items=e.items.filter(e=>e!==t),this.state.inventory.push(t),this.printLine(`You take the ${i.shortName||i.name}.`),!0):(this.printLine(`You can't take the ${i.shortName||i.name}.`),!1):(this.printLine("You can't take that."),!1)}dropItem(t){const e=this.state.inventory.indexOf(t);if(-1===e)return this.printLine("You don't have that item."),!1;const i=this.world.items.get(t);if(!i)return this.printLine("You can't drop that."),!1;const n=this.world.rooms.get(this.state.currentRoom);return n?(this.state.inventory.splice(e,1),n.items||(n.items=[]),n.items.push(t),this.printLine(`You drop the ${i.shortName||i.name}.`),!0):(this.printLine("You can't drop items here."),!1)}useItem(t,e=null){if(-1===this.state.inventory.indexOf(t))return this.printLine("You don't have that item."),!1;const i=this.world.items.get(t);if(!i)return this.printLine("You can't use that."),!1;if(!e)return i.use?i.use(this.state,this):(this.printLine(`You can't use the ${i.shortName||i.name} that way.`),!1);const n=this.state.inventory.includes(e),s=this.world.rooms.get(this.state.currentRoom),o=s&&s.items&&s.items.includes(e),r=s&&s.characters&&s.characters.includes(e);if(!n&&!o&&!r)return this.printLine("You don't see that here."),!1;let a;return a=r?this.world.characters.get(e):this.world.items.get(e),a?i.useOn&&i.useOn[e]?i.useOn[e](this.state,this):a.useWith&&a.useWith[t]?a.useWith[t](this.state,this):(this.printLine(`Using the ${i.shortName||i.name} on the ${i.shortName||a.name} doesn't seem to do anything.`),!1):(this.printLine("You can't use that."),!1)}lookAtItem(t){const e=this.world.rooms.get(this.state.currentRoom);if(!e||!e.items)return this.printLine("You don't see that here."),!1;let i=null;for(const n of e.items){const e=this.world.items.get(n);if(e&&(e.name.toLowerCase().includes(t)||e.aliases&&e.aliases.some(e=>e.toLowerCase().includes(t)))){i=e;break}}return i?(i.look?i.look(this.state,this):i.description?this.printLine(i.description):this.printLine(`It's a ${i.shortName||i.name}.`),!0):(this.printLine("You don't see that here."),!1)}useUntakeableItem(t){const e=this.world.rooms.get(this.state.currentRoom);if(!e||!e.items)return this.printLine("You don't see that here."),!1;let i=null;for(const n of e.items){const e=this.world.items.get(n);if(e&&(e.name.toLowerCase().includes(t)||e.aliases&&e.aliases.some(e=>e.toLowerCase().includes(t)))){i=e;break}}return i?i.use?i.use(this.state,this):(this.printLine(`You're not sure how to use the ${i.shortName||i.name}.`),!1):(this.printLine("You don't see that here."),!1)}async confirm(t){return"browser"===this.env?(this.printLine(t),this.printLine("1. Yes"),this.printLine("2. No"),new Promise(t=>{const e=i=>{const n=i.trim().toLowerCase();"1"===n||"yes"===n||"y"===n?t(!0):"2"===n||"no"===n||"n"===n?t(!1):(this.updateLastLine("Please enter 1 for Yes or 2 for No: "),this.inputElement.addEventListener("keydown",e,{once:!0}))};this.updateLastLine("Select option (1-2): "),this.inputElement.addEventListener("keydown",e,{once:!0})})):(this.printLine(t),this.printLine("1. Yes"),this.printLine("2. No"),new Promise(e=>{this.rl.question("Select option (1-2): ",i=>{const n=i.trim().toLowerCase();"1"===n||"yes"===n||"y"===n?e(!0):"2"===n||"no"===n||"n"===n?e(!1):(this.printLine("Invalid selection. Please try again."),e(this.confirm(t)))})}))}async selectFromList(t,e){return"browser"===this.env?(this.printLine(t),e.forEach((t,e)=>{this.printLine(`${e+1}. ${t}`)}),this.printLine(`${e.length+1}. Cancel`),new Promise(t=>{const i=n=>{const s=parseInt(n.trim(),10);!isNaN(s)&&s>=1&&s<=e.length+1?t(s===e.length+1?-1:s-1):(this.updateLastLine(`Please enter a number between 1 and ${e.length+1}: `),this.inputElement.addEventListener("keydown",i,{once:!0}))};this.updateLastLine(`Select option (1-${e.length+1}): `),this.inputElement.addEventListener("keydown",i,{once:!0})})):(this.printLine(t),e.forEach((t,e)=>{this.printLine(`${e+1}. ${t}`)}),this.printLine(`${e.length+1}. Cancel`),new Promise(i=>{this.rl.question(`Select option (1-${e.length+1}): `,n=>{const s=parseInt(n.trim(),10);!isNaN(s)&&s>=1&&s<=e.length+1?i(s===e.length+1?-1:s-1):(this.printLine("Invalid selection. Please try again."),i(this.selectFromList(t,e)))})}))}saveGame(t="default",e=!1){const n={state:{...this.state},timestamp:Date.now(),slot:t};if("browser"===this.env){const s=JSON.parse(localStorage.getItem(i)||"{}");s[t]=n,localStorage.setItem(i,JSON.stringify(s)),!e&&this.printLine(`{{green}}Game saved in slot: ${t}{{color_reset}}`)}else{const i=this.path.join(__dirname,"saves");this.fs.existsSync(i)||this.fs.mkdirSync(i,{recursive:!0});const s=this.path.join(i,`save_${t}.json`);this.fs.writeFileSync(s,JSON.stringify(n,null,2)),!e&&this.printLine(`{{green}}Game saved in slot: ${t}{{color_reset}}`)}}loadGame(t="default"){try{let e;if("browser"===this.env){e=JSON.parse(localStorage.getItem(i)||"{}")[t]}else{const i=this.path.join(__dirname,"saves",`save_${t}.json`);if(!this.fs.existsSync(i))return this.printLine(`No save file found in slot: ${t}`),!1;e=JSON.parse(this.fs.readFileSync(i,"utf8"))}return e?(this.state=e.state,this.printLine(`Game loaded from slot: ${t}`),this.look(),!0):(this.printLine(`No save file found in slot: ${t}`),!1)}catch(t){return this.printLine(`Error loading game: ${t.message}`),this.config.debug&&console.error(t),!1}}deleteSave(t="default"){try{if("browser"===this.env){const e=JSON.parse(localStorage.getItem(i)||"{}");if(e[t])return delete e[t],localStorage.setItem(i,JSON.stringify(e)),this.printLine(`Save slot ${t} deleted.`),!0}else{const e=this.path.join(__dirname,"saves",`save_${t}.json`);if(this.fs.existsSync(e))return this.fs.unlinkSync(e),this.printLine(`Save slot ${t} deleted.`),!0}return this.printLine(`No save file found in slot: ${t}`),!1}catch(t){return this.printLine(`Error deleting save: ${t.message}`),this.config.debug&&console.error(t),!1}}listSaves(){try{let t={};if("browser"===this.env)t=JSON.parse(localStorage.getItem(i)||"{}");else{const e=this.path.join(__dirname,"saves");if(this.fs.existsSync(e)){this.fs.readdirSync(e).forEach(i=>{if(i.startsWith("save_")&&i.endsWith(".json")){const n=i.replace("save_","").replace(".json",""),s=this.path.join(e,i),o=JSON.parse(this.fs.readFileSync(s,"utf8"));t[n]=o}})}}if(0===Object.keys(t).length)return void this.printLine("No save files found.");this.printLine("Available saves:");for(const[e,i]of Object.entries(t)){const t=new Date(i.timestamp);this.printLine(`- ${e}: ${t.toLocaleString()}`)}}catch(t){this.printLine(`Error listing saves: ${t.message}`),this.config.debug&&console.error(t)}}addRoom(t){return t.id||(t.id=o.uuid()),this.world.rooms.set(t.id,t),t.id}addItem(t){return t.id||(t.id=o.uuid()),t.use=o.deserializeFunction(t.use),this.world.items.set(t.id,t),t.id}addCharacter(t){return t.id||(t.id=o.uuid()),this.world.characters.set(t.id,t),t.id}addEvent(t){return t.id||(t.id=o.uuid()),this.world.events.set(t.id,t),t.id}async loadPlugin(t){try{if((t=await this.prepareModule(t)).id&&!this.plugins.has(t.id)){if(this.plugins.set(t.id,t),t.commands)for(const e of t.commands)this.registerCommand(e);if(t.rooms)for(const e of t.rooms)this.addRoom(e);if(t.items)for(const e of t.items)this.addItem(e);if(t.characters)for(const e of t.characters)this.addCharacter(e);if(t.events)for(const e of t.events)this.addEvent(e);if(t.keybindings)for(const[e,i]of Object.entries(t.keybindings))this.registerKeybinding(e,i);return t.init&&t.init(this),this.printLine(`Plugin loaded: ${t.name||t.id}`),!0}return this.printLine("Invalid plugin format: missing id"),!1}catch(t){return this.printLine(`Error loading plugin: ${t.message}`),this.config.debug&&console.error(t),!1}}unloadPlugin(t){if(this.plugins.has(t)){const e=this.plugins.get(t);if(e.commands)for(const t of Object.keys(e.commands))this.world.commands.delete(t);if(e.rooms)for(const t of e.rooms)this.world.rooms.delete(t.id);if(e.items)for(const t of e.items)this.world.items.delete(t.id);if(e.characters)for(const t of e.characters)this.world.characters.delete(t.id);if(e.events)for(const t of e.events)this.world.events.delete(t.id);if(e.keybindings)for(const t of Object.keys(e.keybindings))this.world.keybindings.delete(t);return this.plugins.delete(t),this.printLine(`Plugin unloaded: ${t}`),!0}return this.printLine(`Plugin not found: ${t}`),!1}async loadTheme(t){try{if(t=await this.prepareModule(t),this.theme={...n,...t},"browser"===this.env){for(const[t,e]of Object.entries(this.theme))document.documentElement.style.setProperty(t,e);this.terminalElement.style.backgroundColor=this.theme["--lore-bg-color"],this.terminalElement.style.color=this.theme["--lore-text-color"],this.terminalElement.style.fontFamily=this.theme["--lore-font-family"],this.terminalElement.style.fontSize=this.theme["--lore-font-size"],this.promptElement.style.color=this.theme["--lore-prompt-color"],this.inputElement.style.color=this.theme["--lore-input-color"],this.theme["--lore-prompt-content"]&&this.updatePrompt(this.theme["--lore-prompt-content"])}else this.theme["--lore-prompt-content"]&&this.updatePrompt(this.theme["--lore-prompt-content"]);return!0}catch(t){return this.printLine(`Error loading theme: ${t.message}`),this.config.debug&&console.error(t),!1}}async prepareModule(t){if("string"==typeof t&&o.isURL(t)){if(!t.endsWith(".js"))return this.printLine("{{red}}Module loaded from URL must be a JavaScript (.js) file{{color_reset}}"),{};try{t="browser"===this.env?await o.loadModule(t):require(t)}catch(t){return this.printLine(`{{red}}Couldn't prepare module\n${t.message}`),{}}}return"string"==typeof t&&(t=JSON.parse(novel)),t}printHelp(t){if(t){!this.world.commands.has(t)&&this.world.aliases.has(t)&&(t=this.world.aliases.get(t));const e=this.world.commands.get(t);if(e){const t=e.aliases&&e.aliases.length?", "+e.aliases.join(", "):"";this.printLine(`{{green}}${e.name}${t}{{color_reset}`),this.printLine("Usage:"),this.printLine(`{{green}}${e.display||e.name}{{color_reset}}`),e.purpose&&this.printLine(`Use it to ${e.purpose}.`)}else this.printLine(""),this.printLine(`Unknown command: ${t}. Type 'help' for available commands.`)}else{this.printLine("{{bold}}Available commands:{{font_reset}}");Array.from(this.world.commands).map(t=>t[1]).sort((t,e)=>t.weight-e.weight).filter(t=>t.help&&-1!=t.weight).forEach(t=>{const e=t.display||t.name,i=t.aliases&&t.aliases.length?", "+t.aliases.join(", "):"",n=t.help;this.printLine(`  {{green}}${e}{{color_reset}}{{green}}${i}{{color_reset}} - ${n}`)})}}registerCommand(t){t&&t.name&&(this.world.commands.set(t.name.toLowerCase(),{name:"foo",aliases:[],fn:()=>{},help:"",weight:null,purpose:null,...t}),t.aliases&&t.aliases.forEach(e=>{this.world.aliases.set(e,t.name.toLowerCase())}))}registerKeybinding(t,e){this.world.keybindings.set(t,e)}registerDefaultCommands(){this.registerCommand({name:"help",aliases:["h","?"],fn:(t,e)=>e.printHelp(t[0]),help:"Show this help",purpose:"see available commands",weight:1e3}),this.registerCommand({name:"look",aliases:["l","see","examine","inspect"],fn:(t,e)=>{if(0===t.length)return void e.look();const i=t.join(" ").toLowerCase();e.lookAtItem(i)},help:"Look around or examine a specific item",purpose:"look around",weight:1}),this.registerCommand({name:"go",display:"go [dir]",fn:(t,e)=>{if(0===t.length){const t=e.world.rooms.get(e.state.currentRoom);return void(t&&t.exits&&"{}"!=!JSON.stringify(t.exits)?e.printRoomExits(t):e.printLine("Go where?"))}e.move(t[0])},help:"Move in a direction",purpose:"move in a direction",weight:2});const t=["north","south","east","west","northeast","northwest","southeast","southwest","up","down","in","out"],e=["n","s","e","w","ne","nw","se","sw","u","d","i","o"];for(let i=0;i<t.length;i++){const n=t[i],s=e[i];this.registerCommand({name:n,aliases:[s],fn:(t,e)=>e.move(n),help:null,purpose:`go ${n}`,weight:-1})}this.registerCommand({name:"take",display:"take [item]",fn:(t,e)=>{if(0===t.length){const t=e.world.rooms.get(e.state.currentRoom);if(!t||!t.items||0===t.items.length)return void e.printLine("Take what? There's nothing here to take.");e.printLine("What would you like to take?");const i=t.items.map(t=>{const i=e.world.items.get(t);return i?`- ${i.name}${i.aliases?` (also: ${i.aliases.join(", ")})`:""}`:"unknown item"}).join("\n");return void e.printLine(i)}const i=e.world.rooms.get(e.state.currentRoom);if(!i||!i.items)return void e.printLine("There's nothing to take here.");const n=t.join(" ").toLowerCase();let s=null;for(const t of i.items){const i=e.world.items.get(t);if(i){if(i.name.toLowerCase().includes(n)){s=t;break}if(i.aliases)for(const e of i.aliases)if(e.toLowerCase().includes(n)){s=t;break}if(s)break}}s?e.takeItem(s):e.printLine("You don't see that here.")},help:"Take an item",purpose:"take something",weight:3}),this.registerCommand({name:"drop",display:"drop [item]",fn:(t,e)=>{if(0===t.length)return void e.printLine("Drop what?");const i=t.join(" ").toLowerCase();let n=null;for(const t of e.state.inventory){const s=e.world.items.get(t);if(s&&s.name.toLowerCase().includes(i)){n=t;break}}n?e.dropItem(n):e.printLine("You don't have that item.")},help:"Drop an item",purpose:"drop something you don't need anymore",weight:4}),this.registerCommand({name:"inventory",aliases:["i"],fn:(t,e)=>{if(0!==e.state.inventory.length){e.printLine("{{bold}}You are carrying:{{font_reset}}");for(const t of e.state.inventory){const i=e.world.items.get(t);i&&e.printLine(`- ${i.name}`)}}else e.printLine("You are carrying nothing.")},help:"Show your inventory",purpose:"show items you have",weight:5}),this.registerCommand({name:"use",display:"use [item]",fn:(t,e)=>{if(0===t.length)return void e.printLine("Use what?");const i=t.join(" ").toLowerCase();let n=null;for(const t of e.state.inventory){const s=e.world.items.get(t);if(s&&(s.name.toLowerCase().includes(i)||s.aliases&&s.aliases.some(t=>t.toLowerCase().includes(i)))){n=t;break}}n?e.useItem(n):e.useUntakeableItem(i)},help:"Use an item from inventory or in the environment",purpose:"use something you have close",weight:6}),this.registerCommand({name:"say",display:"say [...]",fn:(t,e)=>{if(0===t.length)return void e.printLine("You don't say");const i=t.join(" ");e.printLine(`You say:{{n}} - ${i}`);const n=e.world.rooms.get(e.state.currentRoom);if(n&&n.characters){let t=!1;n.characters.forEach(n=>{const s=e.world.characters.get(n);s&&s.onSay&&!t&&(t=!!s.onSay(i,e.state,e))})}},help:"Say something",purpose:"say something",weight:7}),this.registerCommand({name:"talk",display:"talk [character] about [topic]",fn:(t,e)=>{if(0===t.length){const t=e.world.rooms.get(e.state.currentRoom);if(!t||!t.characters||0===t.characters.length)return void e.printLine("Talk to whom? There's no one here.");e.printLine("Who would you like to talk to?");const i=t.characters.map(i=>{const n=e.world.characters.get(i);if(!n)return"unknown character";let s=`- ${n.name}`;return n.aliases&&(s+=` (also: ${n.aliases.join(", ")})`),n.genre&&1===t.characters.length&&(s+=` or use "talk ${"male"===n.genre?"him":"her"}"`),s}).join("\n");return void e.printLine(i)}const i=e.world.rooms.get(e.state.currentRoom);if(!i||!i.characters)return void e.printLine("There's no one here to talk to.");const n=t.findIndex(t=>"about"===t);let s,o=null;-1!==n?(s=t.slice(0,n).join(" ").toLowerCase(),o=t.slice(n+1).join(" ").toLowerCase()):s=t.join(" ").toLowerCase();let r=null,a=null;for(const t of i.characters){const n=e.world.characters.get(t);if(n){if(n.name.toLowerCase().includes(s)){r=t,a=n;break}if(n.aliases){for(const e of n.aliases)if(e.toLowerCase().includes(s)){r=t,a=n;break}if(r)break}if(n.genre&&1===i.characters.length&&("female"===n.genre&&("her"===s||"she"===s)||"male"===n.genre&&("him"===s||"he"===s))){r=t,a=n;break}}}if(r)if(o&&a.topics){let t=!1;for(const[i,n]of Object.entries(a.topics))if(i.toLowerCase().includes(o)||n.aliases&&n.aliases.some(t=>t.toLowerCase().includes(o))){n.condition&&!n.condition(e.state)?e.printLine(n.blockedMessage||`${a.name} doesn't want to talk about that right now.`):(n.dialog(e.state,e),n.setFlag&&(e.state.flags[n.setFlag]=!0)),t=!0;break}t||e.printLine(`${a.shortName||a.name} doesn't seem to know anything about "${o}".`)}else a.talk?a.talk(e.state,e):e.printLine(`${a.shortName||a.name} has nothing to say to you right now.`);else e.printLine("You don't see that person here.")},help:"Talk to someone or ask about a specific topic",purpose:"talk to someone or ask about a specific topic",weight:8}),this.registerCommand({name:"save",display:"save [slot]",fn:(t,e)=>{const i=t.length>0?t[0]:"default";e.saveGame(i)},help:"Save the game",purpose:"save the game",weight:9}),this.registerCommand({name:"load",display:"load [slot]",fn:(t,e)=>{const i=t.length>0?t[0]:"default";e.loadGame(i)},help:"Load a saved game",purpose:"load a saved game",weight:10}),this.registerCommand({name:"restart",fn:()=>this.restartGame(),help:"Restart the game",purpose:"restart the game",weight:11}),this.registerCommand({name:"quit",aliases:["exit"],fn:(t,e)=>{e.printLine("{{green}}Goodbye!{{color_reset}}"),"node"===e.env?e.rl.close():(e.stopAllAnimations(),e.state={currentRoom:null,inventory:[],flags:{},variables:{},history:[],gameTime:0},e.clearScreen())},help:"Quit the game",purpose:"finish playing",weight:999})}async loadNovel(t){try{t=await this.prepareModule(t),this.world.rooms.clear(),this.world.items.clear(),this.world.characters.clear(),this.world.events.clear();const e=new Map(this.world.commands),i=new Map(this.world.keybindings);if(this.world.commands=e,this.world.keybindings=i,t.rooms)for(const e of t.rooms)this.addRoom(e);if(t.items)for(const e of t.items)this.addItem(e);if(t.characters)for(const e of t.characters)this.addCharacter(e);if(t.events)for(const e of t.events)this.addEvent(e);return t.startRoom?this.state.currentRoom=t.startRoom:this.state.currentRoom=null,this.config.clearScreenOnNovelLoad&&this.clearScreen(),this.startGame(this.state.currentRoom),!0}catch(t){return this.printLine(`Error loading novel: ${t.message}`),this.config.debug&&console.error(t),!1}}},Utils:o}});